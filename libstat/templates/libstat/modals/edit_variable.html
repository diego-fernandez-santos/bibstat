{% load i18n %}

<form role="form" class="edit-variable-form" method="post" action="{{form_url}}">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">{% trans 'Stäng' %}</span></button>
        <h4 class="modal-title">{{modal_title}}</h4>
      </div>
      <div class="modal-body">
        {% csrf_token %}
        <span class="text-danger errors all"></span>
        {% if mode == 'create' %}
          <div class="form-group key" data-field="key">
             <label for="id_key">{% trans "Nyckel (unik)" %}</label>
             <span class="text-danger form-validation after"></span>
             {{form.key}}
             <span class="glyphicon glyphicon-remove form-control-feedback"></span>
          </div>
        {% endif %}
        <div class="form-group replaces" data-field="replaces">
          <label for="id_replaces">{% trans "Ersätter termer" %}</label>
          <input type="hidden" id="id_replaces_initial" value="{{form.replaces_initial_value}}" />
          <span class="text-danger form-validation after"></span>
          {{form.replaces}}
          <span class="glyphicon glyphicon-remove form-control-feedback"></span>
        </div>
        <div class="form-group question" data-field="question">
            <label for="id_question">{% trans "Formulärfråga" %}</label>
            <span class="text-danger form-validation after"></span>
            {{form.question}}
            <span class="glyphicon glyphicon-remove form-control-feedback"></span>
        </div>
        <div class="form-group question_part" data-field="question_part">
            <label for="id_question_part">{% trans "Delfråga" %}</label>
            <span class="text-danger form-validation after"></span>
            {{form.question_part}}
            <span class="glyphicon glyphicon-remove form-control-feedback"></span>
        </div>
        <div class="form-group category" data-field="category">
            <label for="id_category">{% trans "Huvudgrupp" %}</label>
            <span class="text-danger form-validation after"></span>
            {{form.category}}
            <span class="glyphicon glyphicon-remove form-control-feedback"></span>
        </div>
        <div class="form-group sub_category" data-field="sub_category">
            <label for="id_sub_category">{% trans "Undergrupp" %}</label>
            <span class="text-danger form-validation after"></span>
            {{form.sub_category}}
            <span class="glyphicon glyphicon-remove form-control-feedback"></span>
        </div>
        <div class="form-group type" data-field="type">
            <label>{% trans "Enhet" %}</label>
            <span class="text-danger form-validation after"></span>
            <div>
              {% for type_choice in form.type %}
                <label class="radio-inline">
                    {{type_choice.tag}}
                    {{type_choice.choice_label}}
                </label>
              {% endfor %}
            </div>
        </div>
        <div class="form-group is_public" data-field="is_public">
            <label>{% trans "Synlighet" %}</label>
            <span class="text-danger form-validation after"></span>
            <div class="checkbox">
              {{form.is_public}}
              {% trans "Termen visas som öppen data" %}
            </div>
        </div>
        <div class="form-group target_groups" data-field="target_groups">
            <label>{% trans "Bibliotekstyper" %}</label>
            <span class="text-danger form-validation after"></span>
            <div>
              {% for target_group in form.target_groups %}
                <label class="checkbox-inline">
                  {{target_group.tag}}
                  {{target_group.choice_label}}
                </label>
              {% endfor %}
            </div>
        </div>
        <div class="form-group description" data-field="description">
            <label for="description">{% trans "Beskrivning" %}</label>
            <span class="text-danger form-validation after"></span>
            {{form.description}}
            <span class="glyphicon glyphicon-remove form-control-feedback"></span>
        </div>
        <div class="form-group comment" data-field="comment">
            <label for="comment">{% trans "Kommentar (visas ej publikt)" %}</label>
            <span class="text-danger form-validation after"></span>
            {{form.comment}}
            <span class="glyphicon glyphicon-remove form-control-feedback"></span>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal" >{% trans "Avbryt" %}</button>
        <input type="submit" class="btn btn-primary" value="{% if mode == 'create' or form.instance.is_draft %}Spara ukast{% else %}Spara ändringar{% endif %}" />
      </div>
      
    </div>
  </div>
</form>

<script type="text/javascript">
$(document).ready(function() {

	var replaceable_variables = new Bloodhound({
		datumTokenizer: function(item) {
			return Bloodhound.tokenizers.whitespace(item.label);
		},
		queryTokenizer: Bloodhound.tokenizers.whitespace,
		limit: 10,
		prefetch: {
		    // url points to a json file that contains an array of country names, see
		    // https://github.com/twitter/typeahead.js/blob/gh-pages/data/countries.json
		  	url: '/statistics/variables/replaceable',
		    // the json file contains an array of strings, but the Bloodhound
		    // suggestion engine expects JavaScript objects so this converts all of
		    // those strings
		    filter: function(list) {
		      return $.map(list, function(item) { 
		    	  return { label: item.key, value: item.id }; 
		      });
		    }
		 },
		/*remote: '/statistics/variables/replaceable',*/
	});
		 
	// kicks off the loading/processing of `local` and `prefetch`
	replaceable_variables.initialize();
	
	var initial_tokens = function() {
		var tokens = []
		var keysIds = $("#id_replaces_initial").val().split(", ");
		return $.map(keysIds, function(keyId) {
			var labelValue = keyId.split(":");
			return { label: labelValue[0], value: labelValue[1] }; 
		});
	}
	$('#id_replaces').tokenfield({
	  	typeahead: [null, {
		  	displayKey: 'label',
		  	source: replaceable_variables.ttAdapter(),
	  	}]
	}).tokenfield('setTokens', initial_tokens());
	
	
	$('.edit-variable-form').submit(function(event) {
		event.preventDefault();
		
		var self = this;
		$(self).find(".form-group").removeClass("has-feedback has-error");
		$(self).find(".form-validation").text("");
	    
		$.ajax({ 
	    	type: $(this).attr('method'), 
	        url: this.action, 
	        data: $(this).serialize(),
	        context: this,
	        success: function(data, status) {
	        	if(data.errors) {
	        		$(".form-group").each(function() {
	        			var field = $(this).attr("data-field")
	        			if(data.errors.hasOwnProperty(field)) {
	        				$(this).addClass("has-feedback has-error");
	        				$(this).find(".form-validation").text(data.errors[field]);
	        			}
	        		})
	        	} else {
    	            console.info("saved variable: ", data);
    	            $('#variableModal').modal('hide');
    	            window.location.reload(true);
	        	}
	        }, 
	        error: function(data, status) {
	        	console.info("An error occured while saving variable!")
	        }
	    });
	    return false;
	});
});
</script>
